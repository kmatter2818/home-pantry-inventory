<!DOCTYPE html>
<html>
<head>
  <title>My Pantry Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">

  <style>
    /* ===== THEME TOKENS ===== */
    :root {
      --bg: #ffffff;
      --surface: #f7f7f9;
      --text: #171717;
      --muted: #6b7280;
      --border: #e5e7eb;
      --primary: #2563eb;
      --primary-contrast: #ffffff;
      --pill-bg: #eef2ff;
      --pill-text: #3730a3;
      --shadow: 0 8px 30px rgba(0,0,0,.08);
    }
    .dark {
      --bg: #111318;
      --surface: #151821;
      --text: #e5e7eb;
      --muted: #a3a3a3;
      --border: #2a2f3a;
      --primary: #60a5fa;
      --primary-contrast: #0b1220;
      --pill-bg: #1f2937;
      --pill-text: #c7d2fe;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
    }

    /* ===== BASE ===== */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      color: var(--text);
      background: radial-gradient(1200px 800px at 50% -10%, var(--surface), var(--bg) 50%);
      transition: background .3s, color .3s;
      padding-bottom: 88px; /* room for tab bar */
      overflow-x: hidden;
    }

    /* ===== HEADER ===== */
    header {
      position: sticky; top: 0; z-index: 5;
      padding: 16px 16px 8px;
      backdrop-filter: blur(6px);
      background: transparent;
    }
    .title {
      margin: 0 0 8px 0;
      text-align: center;
      font-weight: 800;
      letter-spacing: .3px;
      font-size: 22px;
    }
    .top-actions {
      display: flex; justify-content: center; gap: 10px;
    }
    .icon-btn {
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 16px;
      box-shadow: var(--shadow);
      cursor: pointer;
    }
    .icon-btn:active { transform: translateY(1px); }

    /* ===== SCREENS + ANIMATIONS ===== */
    .screens { position: relative; width: 100%; overflow: hidden; }
    .screen {
      position: absolute; inset: 0;
      padding: 6px 12px 84px;
      transform: translateX(100%);
      opacity: 0;
      transition: transform .28s ease, opacity .28s ease;
      will-change: transform, opacity;
    }
    .screen.active { transform: translateX(0%); opacity: 1; z-index: 2; }

    /* ===== CONTENT ===== */
    h2 {
      text-align: center;
      margin: 8px 0 12px;
      font-size: 18px;
      color: var(--muted);
      font-weight: 700;
    }
    .controls {
      display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin: 6px 0 8px;
    }
    input[type="text"], input[type="number"], select {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 16px;
      min-width: 140px;
      outline: none;
    }
    input::placeholder { color: var(--muted); }

    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow);
    }
    .btn.primary {
      background: var(--primary);
      color: var(--primary-contrast);
      border-color: transparent;
    }

    ul { padding-left: 0; margin: 6px 0 0; }
    li {
      list-style: none;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 4px;
      box-shadow: var(--shadow);
    }
    .info { flex: 1; }
    .name { font-weight: 700; }
    .muted { color: var(--muted); }
    .done .name { text-decoration: line-through; opacity: .6; }

    /* Category pills */
    .pills { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px; }
    .pill {
      background: var(--pill-bg);
      color: var(--pill-text);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }

    /* Row action buttons */
    .row-btn {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 14px;
      min-width: 36px;
      cursor: pointer;
    }

    /* ===== TAB BAR ===== */
    #tabBar {
      position: fixed; bottom: 0; left: 0; width: 100%;
      display: flex; z-index: 10;
      backdrop-filter: blur(6px);
      border-top: 1px solid var(--border);
      background: color-mix(in oklab, var(--surface) 85%, transparent);
    }
    #tabBar button {
      flex: 1; padding: 14px 10px; margin: 0;
      background: transparent; color: var(--text);
      border: none; border-right: 1px solid var(--border);
      font-size: 20px; font-weight: 700;
      transition: transform .18s ease, background .18s ease, color .18s ease;
      cursor: pointer;
    }
    #tabBar button:last-child { border-right: none; }
    #tabBar button.active {
      background: var(--primary);
      color: var(--primary-contrast);
      transform: scale(1.12);
      text-shadow: 0 1px 0 rgba(0,0,0,0.12);
    }

    /* ===== FAB ===== */
    .fab {
      position: fixed; right: 18px; bottom: 96px;
      width: 56px; height: 56; border-radius: 50%;
      background: var(--primary); color: var(--primary-contrast);
      font-size: 28px; border: none;
      display: grid; place-items: center;
      box-shadow: var(--shadow);
      z-index: 9; cursor: pointer;
    }

    /* ===== BOTTOM SHEET ===== */
    .sheet-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.35);
      opacity: 0; pointer-events: none;
      transition: opacity .22s ease;
      z-index: 50;
    }
    .sheet-backdrop.open { opacity: 1; pointer-events: auto; }

    .sheet {
      position: fixed; left: 0; right: 0; bottom: -100%;
      background: var(--bg);
      border-top-left-radius: 20px; border-top-right-radius: 20px;
      box-shadow: var(--shadow);
      padding: 16px 16px 22px;
      transition: transform .26s ease;
      transform: translateY(100%);
      z-index: 51;
    }
    .sheet.open { transform: translateY(0%); bottom: 0; }
    .sheet .grabber {
      width: 46px; height: 5px; border-radius: 999px;
      background: var(--border); margin: 0 auto 12px;
    }
    .sheet h3 { text-align: center; margin: 4px 0 10px; }

    .sheet form {
      display: grid; grid-template-columns: 1fr 110px;
      gap: 8px 10px; align-items: center; max-width: 560px; margin: 0 auto;
    }
    .sheet form .full { grid-column: 1 / -1; }
    .sheet .actions { display: flex; gap: 8px; justify-content: center; margin-top: 8px; }

    @media (max-width: 600px) {
      .sheet form { grid-template-columns: 1fr 100px; }
      #tabBar button { font-size: 18px; padding: 12px 8px; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <h1 class="title">My Pantry Tracker</h1>
    <div class="top-actions">
      <button class="icon-btn" onclick="manualRefresh()">üîÑ Refresh</button>
      <button class="icon-btn" onclick="toggleTheme()">üåì Theme</button>
    </div>
  </header>

  <!-- Screens -->
  <main class="screens" id="screens">
    <!-- Shopping -->
    <section id="screen-shopping" class="screen active">
      <h2>Shopping</h2>
      <div class="controls">
        <input id="searchInput" type="text" placeholder="Search shopping‚Ä¶" oninput="render()">
        <button class="btn" onclick="sortAlpha()">Sort A‚ÜíZ</button>
        <button class="btn" onclick="sortCat()">Sort by Category</button>
      </div>
      <ul id="shoppingList"></ul>
    </section>

    <!-- Pantry -->
    <section id="screen-pantry" class="screen">
      <h2>Pantry</h2>
      <div class="controls">
        <input id="searchInputPantry" type="text" placeholder="Search pantry‚Ä¶" oninput="render()">
        <button class="btn" onclick="sortAlpha()">Sort A‚ÜíZ</button>
        <button class="btn" onclick="sortCat()">Sort by Category</button>
      </div>
      <ul id="pantryList"></ul>
    </section>

    <!-- (Add screen is handled by bottom sheet) -->
    <section id="screen-add" class="screen"></section>
  </main>

  <!-- Floating Quick Add -->
  <button class="fab" onclick="openSheet()">+</button>

  <!-- Bottom Sheet -->
  <div class="sheet-backdrop" id="sheetBackdrop" onclick="closeSheet()"></div>
  <div class="sheet" id="sheet">
    <div class="grabber"></div>
    <h3>Add Item</h3>
    <form onsubmit="event.preventDefault(); addItemFromSheet();">
      <input id="itemInput" type="text" placeholder="Item name" class="full" required>
      <input id="qtyInput" type="number" placeholder="Qty" min="1" value="1" required>

      <select id="catInput" class="full">
        <option value="">Category (optional)</option>
        <option>Dairy</option>
        <option>Produce</option>
        <option>Meat</option>
        <option>Canned</option>
        <option>Bread</option>
      </select>

      <select id="destInput" class="full">
        <option value="shopping">Add ‚Üí Shopping</option>
        <option value="pantry">Add ‚Üí Pantry</option>
      </select>

      <div class="actions full">
        <button type="button" class="btn" onclick="closeSheet()">Cancel</button>
        <button type="submit" class="btn primary">Add Item</button>
      </div>
    </form>
  </div>

  <!-- Tabs -->
  <nav id="tabBar">
    <button onclick="showScreen('shopping')" class="active">üõí</button>
    <button onclick="showScreen('pantry')">üè†</button>
    <button onclick="showScreen('add'); openSheet();">‚ûï</button>
  </nav>

<script>
  /* ===== CONFIG ===== */
  const API_BASE = "https://pantry-api-74qw.onrender.com";
  const HOUSEHOLD_KEY = "home";
  let items = [];
  let currentScreen = "shopping";

  /* ===== THEME ===== */
  function applyTheme(theme) {
    if (theme === "dark") document.body.classList.add("dark");
    else document.body.classList.remove("dark");
  }
  function toggleTheme() {
    const curr = localStorage.getItem("theme") || "light";
    const next = curr === "light" ? "dark" : "light";
    localStorage.setItem("theme", next);
    applyTheme(next);
  }
  applyTheme(localStorage.getItem("theme") || "light");

  /* ===== API HELPERS ===== */
  function toPayload(x) {
    return {
      household: HOUSEHOLD_KEY,
      name: x.name,
      qty: x.qty,
      cat: x.cat || "",
      exp: x.exp || null,
      done: !!x.done,
      location: x.location
    };
  }
  async function apiGet() {
    const res = await fetch(`${API_BASE}/items?household=${encodeURIComponent(HOUSEHOLD_KEY)}`);
    return await res.json();
  }
  async function apiCreate(x) {
    const res = await fetch(`${API_BASE}/items`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(toPayload(x))
    });
    return await res.json();
  }
  async function apiUpdate(x) {
    const res = await fetch(`${API_BASE}/items/${x.id}`, {
      method: "PUT",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(toPayload(x))
    });
    return await res.json();
  }
  async function apiDelete(id) {
    await fetch(`${API_BASE}/items/${id}?household=${encodeURIComponent(HOUSEHOLD_KEY)}`, { method: "DELETE" });
  }

  /* ===== LOAD + REFRESH ===== */
  async function loadItems() {
    try {
      items = await apiGet();
      localStorage.setItem("cache_items", JSON.stringify(items));
    } catch {
      items = JSON.parse(localStorage.getItem("cache_items") || "[]");
    }
    render();
  }
  async function manualRefresh() { await loadItems(); }
  setInterval(loadItems, 10_000);
  window.addEventListener("online", loadItems);

  /* ===== NAV + ANIMATIONS ===== */
  function showScreen(scr) {
    if (scr === "add") { highlightTab("add"); return; }
    const order = ["shopping", "pantry"];
    const fromIdx = order.indexOf(currentScreen);
    const toIdx = order.indexOf(scr);
    currentScreen = scr;
    highlightTab(scr);

    const fromEl = document.getElementById(`screen-${order[fromIdx]}`);
    const toEl   = document.getElementById(`screen-${order[toIdx]}`);

    fromEl.classList.add("active");
    toEl.classList.add("active");

    if (toIdx > fromIdx) {
      fromEl.style.transform = "translateX(0%)";
      toEl.style.transform   = "translateX(100%)";
      requestAnimationFrame(() => {
        fromEl.style.transform = "translateX(-100%)";
        toEl.style.transform   = "translateX(0%)";
      });
    } else if (toIdx < fromIdx) {
      fromEl.style.transform = "translateX(0%)";
      toEl.style.transform   = "translateX(-100%)";
      requestAnimationFrame(() => {
        fromEl.style.transform = "translateX(100%)";
        toEl.style.transform   = "translateX(0%)";
      });
    } else {
      toEl.style.transform = "translateX(0%)";
    }

    setTimeout(() => {
      document.querySelectorAll(".screen").forEach(s => {
        if (!s.id.endsWith(scr)) {
          s.classList.remove("active");
          s.style.transform = "translateX(100%)";
        }
      });
    }, 280);
  }
  function highlightTab(scr) {
    const btns = document.querySelectorAll("#tabBar button");
    btns.forEach(b => b.classList.remove("active"));
    if (scr === "shopping") btns[0].classList.add("active");
    if (scr === "pantry")   btns[1].classList.add("active");
    if (scr === "add")      btns[2].classList.add("active");
  }

  // Swipe Shopping <-> Pantry
  let touchStartX = 0;
  document.addEventListener("touchstart", e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
  document.addEventListener("touchend", e => {
    const diff = e.changedTouches[0].screenX - touchStartX;
    if (Math.abs(diff) < 60) return;
    const order = ["shopping", "pantry"];
    const i = order.indexOf(currentScreen);
    if (diff < 0 && i < order.length - 1) showScreen(order[i+1]);   // left swipe ‚Üí next
    if (diff > 0 && i > 0)                  showScreen(order[i-1]);   // right swipe ‚Üí prev
  }, { passive: true });

  /* ===== BOTTOM SHEET ===== */
  const sheet = document.getElementById("sheet");
  const sheetBackdrop = document.getElementById("sheetBackdrop");

  function openSheet() {
    sheet.classList.add("open");
    sheetBackdrop.classList.add("open");
    requestAnimationFrame(() => document.getElementById("itemInput").focus());
  }
  function closeSheet() {
    sheet.classList.remove("open");
    sheetBackdrop.classList.remove("open");
    highlightTab(currentScreen); // if Add tab was lit, snap back
  }

  async function addItemFromSheet() {
    const name = itemInput.value.trim();
    const qty  = qtyInput.value.trim();
    const cat  = catInput.value.trim();
    const dest = (destInput.value || "shopping").toLowerCase();
    if (!name || !qty) return;

    await apiCreate({ name, qty, cat, exp: null, done: false, location: dest });

    // ‚úÖ authoritative refresh from DB to avoid stale UI
    await loadItems();

    clearForm();
    closeSheet();
    showScreen(dest === "shopping" ? "shopping" : "pantry");
  }

  function clearForm() {
    itemInput.value = "";
    qtyInput.value  = "1";
    catInput.value  = "";
    destInput.value = "shopping";
  }

  /* ===== ITEM ACTIONS ===== */
  async function toggleDone(idx) {
    const x = items[idx];
    x.done = !x.done;
    const updated = await apiUpdate(x);
    items[idx] = updated;
    localStorage.setItem("cache_items", JSON.stringify(items));
    render();
  }
  async function moveItem(idx) {
    const x = items[idx];
    x.location = x.location === "shopping" ? "pantry" : "shopping";
    const updated = await apiUpdate(x);
    items[idx] = updated;
    localStorage.setItem("cache_items", JSON.stringify(items));
    render();
  }
  async function editItem(idx) {
    const x = items[idx];
    const name = prompt("Name:", x.name); if (name === null) return;
    const qty  = prompt("Qty:",  x.qty);  if (qty  === null) return;
    const cat  = prompt("Category:", x.cat || ""); if (cat === null) return;
    const exp  = prompt("Expiration (YYYY-MM-DD):", x.exp || ""); if (exp === null) return;
    Object.assign(x, { name, qty, cat, exp });
    const updated = await apiUpdate(x);
    items[idx] = updated;
    localStorage.setItem("cache_items", JSON.stringify(items));
    render();
  }
  async function deleteItem(idx) {
    await apiDelete(items[idx].id);
    items.splice(idx,1);
    localStorage.setItem("cache_items", JSON.stringify(items));
    render();
  }

  /* ===== SORTS ===== */
  function sortAlpha() { items.sort((a,b)=>a.name.localeCompare(b.name)); render(); }
  function sortCat()   { items.sort((a,b)=>(a.cat||"").localeCompare(b.cat||"")); render(); }

  /* ===== RENDER ===== */
  function pill(text) {
    if (!text) return "";
    const span = document.createElement("span");
    span.className = "pill";
    span.textContent = text;
    return span;
  }

  function render() {
    const sUL = document.getElementById("shoppingList");
    const pUL = document.getElementById("pantryList");
    sUL.innerHTML = ""; pUL.innerHTML = "";

    const fShop   = (document.getElementById("searchInput").value || "").toLowerCase();
    const fPantry = (document.getElementById("searchInputPantry").value || "").toLowerCase();

    items.forEach((item, index) => {
      const loc = (item.location || "").toLowerCase(); // ‚úÖ normalize
      const isShopping = loc === "shopping";
      const isPantry   = loc === "pantry";
      if (!isShopping && !isPantry) return; // ignore unknown locations

      // search filter per tab
      const match =
        (isShopping ? (!fShop   || item.name.toLowerCase().includes(fShop))
                    : (!fPantry || item.name.toLowerCase().includes(fPantry)));
      if (!match) return;

      const li  = document.createElement("li");
      if (item.done) li.classList.add("done");

      const chk = document.createElement("input");
      chk.type = "checkbox"; chk.checked = item.done;
      chk.onchange = () => toggleDone(index);

      const info = document.createElement("div");
      info.className = "info";

      const title = document.createElement("div");
      title.innerHTML = `<span class="name">${escapeHtml(item.name)}</span> <span class="muted">‚Äî x${escapeHtml(item.qty)}</span>`;

      const pills = document.createElement("div");
      pills.className = "pills";
      if (item.cat) pills.appendChild(pill(item.cat));
      if (item.exp) pills.appendChild(pill(`Exp ${item.exp}`));
      pills.appendChild(pill(isShopping ? "Shopping" : "Pantry"));

      info.appendChild(title);
      info.appendChild(pills);

      const moveBtn = document.createElement("button");
      moveBtn.className = "row-btn";
      moveBtn.title = "Move";
      moveBtn.textContent = isShopping ? "‚û°" : "‚¨Ö";
      moveBtn.onclick = () => moveItem(index);

      const editBtn = document.createElement("button");
      editBtn.className = "row-btn";
      editBtn.textContent = "Edit";
      editBtn.onclick = () => editItem(index);

      const delBtn = document.createElement("button");
      delBtn.className = "row-btn";
      delBtn.textContent = "‚úï";
      delBtn.onclick = () => deleteItem(index);

      li.appendChild(chk);
      li.appendChild(info);
      li.appendChild(moveBtn);
      li.appendChild(editBtn);
      li.appendChild(delBtn);

      if (isShopping) sUL.appendChild(li);
      else           pUL.appendChild(li);
    });
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
  }

  /* ===== STARTUP ===== */
  window.addEventListener("load", () => {
    loadItems();
    document.getElementById("screen-shopping").classList.add("active");
    document.getElementById("screen-shopping").style.transform = "translateX(0%)";
  });
</script>

<script>
  /* Register service worker */
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("./service-worker.js")
        .then(() => console.log("‚úÖ Service Worker Registered"))
        .catch(err => console.log("SW reg failed:", err));
    });
  }
</script>

</body>
</html>















