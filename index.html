<!DOCTYPE html>
<html>
<head>
  <title>My Pantry Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ‚úÖ PWA manifest -->
  <link rel="manifest" href="./manifest.json">

  <style>
    :root {
      --bg: #ffffff;
      --text: #000000;
      --border: #cccccc;
      --item-bg: #ffffff;
      --button-bg: #f0f0f0;
      --button-text: #000000;
    }

    .dark {
      --bg: #1e1e1e;
      --text: #e8e8e8;
      --border: #555;
      --item-bg: #2a2a2a;
      --button-bg: #333;
      --button-text: #e8e8e8;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
      padding-bottom: 70px;
      overflow-x: hidden;
    }

    h1 {
      text-align: center;
      margin: 12px 0 6px 0;
    }

    h2 {
      text-align: center;
    }

    #topButtons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 6px 0;
    }

    input, select {
      padding: 8px;
      margin: 4px;
      font-size: 1rem;
      background: var(--item-bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      width: 90%;
      max-width: 320px;
    }

    button {
      padding: 6px 10px;
      margin: 4px;
      font-size: 0.9rem;
      border-radius: 6px;
      cursor: pointer;
      background: var(--button-bg);
      color: var(--button-text);
      border: 1px solid var(--border);
    }

    ul {
      padding-left: 0;
    }

    li {
      list-style: none;
      border-bottom: 1px solid var(--border);
      padding: 6px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      background: var(--item-bg);
      margin: 0 12px;
    }

    .info {
      flex: 1;
    }

    .done {
      text-decoration: line-through;
      color: gray;
    }

    /* ‚úÖ Category Pills */
    .pills {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .pill {
      background: #eef2ff;
      color: #3730a3;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }
    .dark .pill {
      background: #1f2937;
      color: #c7d2fe;
    }

    /* bottom tabs */
    #tabBar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      display: flex;
      background: var(--item-bg);
      border-top: 1px solid var(--border);
    }

    #tabBar button {
      flex: 1;
      padding: 12px;
      margin: 0;
      background: var(--button-bg);
      color: var(--button-text);
      border: none;
      border-right: 1px solid var(--border);
      font-size: 1.5rem;
      transition: transform 0.2s;
    }

    #tabBar button:last-child {
      border-right: none;
    }

    #tabBar button.active {
      background: var(--text);
      color: var(--bg);
      transform: scale(1.15);
      font-weight: bold;
    }

    .screen {
      display: none;
      padding-bottom: 60px;
    }

    .screen.active {
      display: block;
    }

    @media (max-width: 600px) {
      button {
        padding: 4px 6px;
        font-size: 0.8rem;
      }
      li { gap: 4px; }
    }
  </style>
</head>

<body>

  <h1>My Pantry Tracker</h1>

  <div id="topButtons">
    <button onclick="manualRefresh()">üîÑ</button>
    <button onclick="toggleTheme()">üåì</button>
  </div>

  <!-- ‚úÖ SCREENS -->

  <div id="screen-shopping" class="screen active">
    <h2>Shopping List</h2>
    <input id="searchInput" placeholder="Search..." oninput="render()">
    <button onclick="sortAlpha()">Sort A‚ÜíZ</button>
    <button onclick="sortCat()">Sort by Category</button>
    <ul id="shoppingList"></ul>
  </div>

  <div id="screen-pantry" class="screen">
    <h2>Pantry</h2>
    <input id="searchInputPantry" placeholder="Search..." oninput="render()">
    <button onclick="sortAlpha()">Sort A‚ÜíZ</button>
    <button onclick="sortCat()">Sort by Category</button>
    <ul id="pantryList"></ul>
  </div>

  <div id="screen-add" class="screen">
    <h2>Add Item</h2>

    <input id="itemInput" type="text" placeholder="Item">
    <input id="qtyInput" type="number" placeholder="Qty" min="1">

    <select id="catInput">
      <option value="">Category</option>
      <option>Dairy</option>
      <option>Produce</option>
      <option>Meat</option>
      <option>Canned</option>
      <option>Bread</option>
    </select>

    <select id="destInput">
      <option value="shopping">Add ‚Üí Shopping</option>
      <option value="pantry">Add ‚Üí Pantry</option>
    </select>

    <br>
    <button onclick="addItem()">Add</button>
  </div>

  <!-- ‚úÖ TABS -->
  <div id="tabBar">
    <button onclick="showScreen('shopping')" class="active">üõí</button>
    <button onclick="showScreen('pantry')">üè†</button>
    <button onclick="showScreen('add')">‚ûï</button>
  </div>


<script>
  const API_BASE = "https://pantry-api-74qw.onrender.com";
  const HOUSEHOLD_KEY = "home";
  let items = [];


  /* ========= SCREEN NAV ========= */
  function showScreen(scr) {
    ["shopping", "pantry", "add"].forEach(s => {
      document.getElementById(`screen-${s}`).classList.remove("active");
    });
    document.getElementById(`screen-${scr}`).classList.add("active");

    const btns = document.querySelectorAll("#tabBar button");
    btns.forEach(btn => btn.classList.remove("active"));

    if (scr === "shopping")  btns[0].classList.add("active");
    if (scr === "pantry")    btns[1].classList.add("active");
    if (scr === "add")       btns[2].classList.add("active");
  }


  /* ========= SWIPE ========= */
  let touchStartX = 0;
  document.addEventListener("touchstart", e => {
    touchStartX = e.changedTouches[0].screenX;
  });

  document.addEventListener("touchend", e => {
    let diff = e.changedTouches[0].screenX - touchStartX;
    if (Math.abs(diff) < 60) return;

    let current = document.querySelector(".screen.active").id.replace("screen-", "");
    const ordered = ["shopping", "pantry", "add"];
    let i = ordered.indexOf(current);

    if (diff < 0 && i < ordered.length - 1) showScreen(ordered[i+1]);
    if (diff > 0 && i > 0) showScreen(ordered[i-1]);
  });


  /* ========= THEME ========= */
  function applyTheme(theme) {
    if (theme === "dark") document.body.classList.add("dark");
    else document.body.classList.remove("dark");
  }

  function toggleTheme() {
    const curr = localStorage.getItem("theme") || "light";
    const next = curr === "light" ? "dark" : "light";
    localStorage.setItem("theme", next);
    applyTheme(next);
  }

  applyTheme(localStorage.getItem("theme") || "light");


  /* ========= API HELPERS ========= */

  async function apiGet() {
    const res = await fetch(
      `${API_BASE}/items?household=${encodeURIComponent(HOUSEHOLD_KEY)}&_=${Date.now()}`,
      { cache: "no-store", headers: { "Cache-Control": "no-cache" } }
    );
    return await res.json();
  }

  function toPayload(x) {
    return {
      household: HOUSEHOLD_KEY,
      name: x.name,
      qty: x.qty,
      cat: x.cat || "",
      exp: x.exp || null,
      done: !!x.done,
      location: x.location
    };
  }

  async function apiCreate(x) {
    const res = await fetch(`${API_BASE}/items`, {
      method: "POST",
      headers: {"Content-Type": "application/json", "Cache-Control":"no-cache"},
      cache: "no-store",
      body: JSON.stringify(toPayload(x))
    });
    return await res.json();
  }

  async function apiUpdate(x) {
    const res = await fetch(`${API_BASE}/items/${x.id}`, {
      method: "PUT",
      headers: {"Content-Type": "application/json", "Cache-Control":"no-cache"},
      cache: "no-store",
      body: JSON.stringify(toPayload(x))
    });
    return await res.json();
  }

  async function apiDelete(id) {
    await fetch(
      `${API_BASE}/items/${id}?household=${encodeURIComponent(HOUSEHOLD_KEY)}&_=${Date.now()}`,
      { method:"DELETE", cache:"no-store", headers:{ "Cache-Control":"no-cache"} }
    );
  }


  /* ========= LOAD ========= */
  async function loadItems() {
    try {
      items = await apiGet();
      localStorage.setItem("cache_items", JSON.stringify(items));
    } catch {
      items = JSON.parse(localStorage.getItem("cache_items") || "[]");
    }
    render();
  }

  async function manualRefresh() {
    await loadItems();
  }

  setInterval(loadItems, 10_000);
  window.addEventListener("online", loadItems);


  /* ========= ADD ITEM ========= */
  async function addItem() {
    const name = itemInput.value.trim();
    const qty  = qtyInput.value.trim();
    const cat  = catInput.value.trim();
    const dest = destInput.value;

    if (!name || !qty) return;

    await apiCreate({ name, qty, cat, exp:null, done:false, location:dest });

    await loadItems();
    clearForm();
    showScreen("shopping");
  }

  function clearForm() {
    itemInput.value = "";
    qtyInput.value = "";
    catInput.value = "";
    destInput.value = "shopping";
  }


  /* ========= ITEM ACTIONS ========= */
  async function toggleDone(idx) {
    const x = items[idx];
    x.done = !x.done;
    items[idx] = await apiUpdate(x);
    localStorage.setItem("cache_items", JSON.stringify(items));
    render();
  }

  async function moveItem(idx) {
    const x = items[idx];
    x.location = x.location === "shopping" ? "pantry" : "shopping";
    items[idx] = await apiUpdate(x);
    localStorage.setItem("cache_items", JSON.stringify(items));
    render();
  }

  async function editItem(idx) {
    const x = items[idx];

    const name = prompt("Name:", x.name);
    if (name===null) return;

    const qty  = prompt("Qty:", x.qty);
    if (qty===null) return;

    const cat  = prompt("Category:", x.cat || "");
    if (cat===null) return;

    const exp  = prompt("Expiration (YYYY-MM-DD):", x.exp || "");
    if (exp===null) return;

    Object.assign(x, { name, qty, cat, exp });
    items[idx] = await apiUpdate(x);
    localStorage.setItem("cache_items", JSON.stringify(items));
    render();
  }

  async function deleteItem(idx) {
    await apiDelete(items[idx].id);
    items.splice(idx,1);
    localStorage.setItem("cache_items", JSON.stringify(items));
    render();
  }

  function sortAlpha() {
    items.sort((a, b) => a.name.localeCompare(b.name));
    render();
  }

  function sortCat() {
    items.sort((a, b) => (a.cat||"").localeCompare(b.cat||""));
    render();
  }


  /* ========= RENDER ========= */

  function makePill(text) {
    if (!text) return null;
    const span = document.createElement("span");
    span.className = "pill";
    span.textContent = text;
    return span;
  }

  function render() {
    shoppingList.innerHTML = "";
    pantryList.innerHTML = "";

    const fShop = (document.getElementById("searchInput").value || "").toLowerCase();
    const fPan  = (document.getElementById("searchInputPantry").value || "").toLowerCase();

    items.forEach((item, index) => {

      const loc = (item.location || "").toLowerCase();
      const li = document.createElement("li");

      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.checked = item.done;
      chk.onchange = () => toggleDone(index);

      const info = document.createElement("div");
      info.className = "info";

      const top = document.createElement("div");
      const expText = item.exp ? ` ‚Äî ${item.exp}` : "";
      top.textContent = `${item.name} ‚Äî ${item.qty} ‚Äî ${item.cat||""}${expText}`;
      if (item.done) top.classList.add("done");

      const pills = document.createElement("div");
      pills.className = "pills";
      if (item.cat) pills.appendChild(makePill(item.cat));
      if (item.exp) pills.appendChild(makePill(`Exp ${item.exp}`));
      pills.appendChild(makePill(loc === "shopping" ? "Shopping" : "Pantry"));

      info.appendChild(top);
      info.appendChild(pills);

      const moveBtn = document.createElement("button");
      moveBtn.textContent = (loc === "shopping") ? "‚û°" : "‚¨Ö";
      moveBtn.onclick = () => moveItem(index);

      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit";
      editBtn.onclick = () => editItem(index);

      const delBtn = document.createElement("button");
      delBtn.textContent = "X";
      delBtn.onclick = () => deleteItem(index);

      li.append(chk, info, moveBtn, editBtn, delBtn);

      if (loc === "shopping") {
        if (!fShop || item.name.toLowerCase().includes(fShop)) {
          shoppingList.appendChild(li);
        }
      } else if (loc === "pantry") {
        if (!fPan || item.name.toLowerCase().includes(fPan)) {
          pantryList.appendChild(li);
        }
      }
    });
  }

  window.addEventListener("load", loadItems);
</script>


<!-- ‚úÖ Register service worker -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("./service-worker.js")
        .then(() => console.log("‚úÖ Service Worker Registered"))
        .catch(err => console.log("SW reg failed:", err));
    });
  }
</script>

</body>
</html>


















